<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      width: 450px;
      padding: 15px;
      font-family: Arial, sans-serif;
    }
    h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .hint {
      font-size: 11px;
      color: #999;
      margin-bottom: 10px;
    }
    textarea {
      width: 100%;
      height: 120px;
      margin: 10px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      font-family: Arial, sans-serif;
      font-size: 13px;
    }
    button {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #output {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      min-height: 80px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
    }
    .hidden {
      display: none;
    }
    .placeholder {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 4px;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid #90caf9;
      font-weight: 500;
      position: relative;
    }
    .placeholder:hover {
      background: #bbdefb;
      border-color: #1976d2;
      transform: translateY(-1px);
    }
    .placeholder::after {
      content: attr(data-original);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 100;
      margin-bottom: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .placeholder:hover::after {
      opacity: 1;
      visibility: visible;
    }
    .placeholder.restored {
      background: #c8e6c9;
      color: #388e3c;
      border-color: #81c784;
      cursor: pointer;
      animation: restoreFlash 0.5s ease;
    }
    .placeholder.restored:hover {
      background: #a5d6a7;
      border-color: #388e3c;
    }
    @keyframes restoreFlash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .copy-btn {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      background: #666;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .copy-btn:hover {
      background: #555;
    }
    .copy-btn.copied {
      background: #4caf50;
    }
    .error {
      color: #d32f2f;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h3>PromptShield</h3>
  <p class="hint">Hover to see original • Click to toggle</p>
  <textarea id="input" placeholder="Enter text to anonymize..."></textarea>
  <button id="anonymize">Anonymize</button>
  <div id="output" class="hidden"></div>
  <button id="copy" class="copy-btn hidden">Copy to Clipboard</button>
  
  <script>
    // Store the mapping globally
    let currentMapping = {};

    document.addEventListener('DOMContentLoaded', function() {
      const anonymizeBtn = document.getElementById('anonymize');
      const copyBtn = document.getElementById('copy');
      const inputEl = document.getElementById('input');
      const outputEl = document.getElementById('output');

      anonymizeBtn.addEventListener('click', async function() {
        const input = inputEl.value;
        
        if (!input.trim()) {
          outputEl.innerHTML = '<span class="error">Please enter some text</span>';
          outputEl.classList.remove('hidden');
          copyBtn.classList.add('hidden');
          return;
        }
        
        // Disable button during request
        anonymizeBtn.disabled = true;
        anonymizeBtn.textContent = 'Processing...';
        
        try {
          const response = await fetch('http://localhost:5050/anonymize', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ text: input })
          });
          
          if (!response.ok) {
            throw new Error('Server error: ' + response.status);
          }
          
          const data = await response.json();
          currentMapping = data.mapping || {};
          
          // Make placeholders clickable
          makeClickable(data.result);
          
          outputEl.classList.remove('hidden');
          copyBtn.classList.remove('hidden');
        } catch (error) {
          console.error('Error:', error);
          outputEl.innerHTML = '<span class="error">Error: Make sure the server is running.<br>Run: python extension_server.py</span>';
          outputEl.classList.remove('hidden');
          copyBtn.classList.add('hidden');
        } finally {
          anonymizeBtn.disabled = false;
          anonymizeBtn.textContent = 'Anonymize';
        }
      });

      copyBtn.addEventListener('click', function() {
        const text = outputEl.textContent;
        navigator.clipboard.writeText(text).then(function() {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          setTimeout(function() {
            copyBtn.textContent = originalText;
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });
    });

    // Make placeholders clickable
    function makeClickable(text) {
      const output = document.getElementById('output');
      
      // Replace all placeholders with clickable spans
      const placeholderPattern = /\[([A-Z_\-À-ÿ\s]+)_(\d+)\]/g;
      let html = text.replace(placeholderPattern, function(match) {
        const original = currentMapping[match] || '';
        return '<span class="placeholder" data-placeholder="' + match + '" data-original="' + original + '" data-state="placeholder" title="Original: ' + original + '">' + match + '</span>';
      });
      
      output.innerHTML = html;
      
      // Add click listeners to all placeholders
      const placeholders = output.querySelectorAll('.placeholder');
      placeholders.forEach(function(placeholder) {
        placeholder.addEventListener('click', function() {
          togglePlaceholder(this);
        });
      });
    }

    // Toggle between placeholder and original value
    function togglePlaceholder(element) {
      const placeholder = element.dataset.placeholder;
      const currentState = element.dataset.state;
      
      if (currentState === 'placeholder') {
        // Restore to original value
        if (!currentMapping[placeholder]) return;
        
        const originalValue = currentMapping[placeholder];
        element.textContent = originalValue;
        element.classList.add('restored');
        element.dataset.state = 'restored';
        element.title = 'Click to show ' + placeholder;
      } else {
        // Restore to placeholder
        element.textContent = placeholder;
        element.classList.remove('restored');
        element.dataset.state = 'placeholder';
        element.title = 'Click to restore original value';
      }
    }
  </script>
</body>
</html>
